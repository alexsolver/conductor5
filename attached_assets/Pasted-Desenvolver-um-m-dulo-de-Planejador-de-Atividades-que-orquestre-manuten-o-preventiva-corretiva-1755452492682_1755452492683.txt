Desenvolver um **m√≥dulo de Planejador de Atividades** que orquestre manuten√ß√£o preventiva, corretiva e preditiva em ativos e locais, com planos, ordens de servi√ßo (OS), checklists, calend√°rios/turnos, aloca√ß√£o de equipes, SLA/tempo ocioso, aprova√ß√µes, pe√ßas/estoque e app m√≥vel com offline.

---

## üèóÔ∏è Requisitos Arquiteturais OBRIGAT√ìRIOS

### Clean Architecture 100% Compliance
```
server/modules/activity-planner/
‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îú‚îÄ‚îÄ entities/           ‚Üí Asset.ts, MaintenancePlan.ts, WorkOrder.ts, Schedule.ts
‚îÇ   ‚îú‚îÄ‚îÄ repositories/       ‚Üí IAssetRepository.ts, IWorkOrderRepository.ts, IScheduleRepository.ts
‚îÇ   ‚îú‚îÄ‚îÄ services/          ‚Üí SchedulingEngine.ts, SLACalculator.ts, MaintenanceDomainService.ts
‚îÇ   ‚îî‚îÄ‚îÄ value-objects/     ‚Üí SLAPolicy.ts, WorkOrderStatus.ts, TaskStatus.ts
‚îú‚îÄ‚îÄ application/
‚îÇ   ‚îú‚îÄ‚îÄ controllers/       ‚Üí AssetController.ts, WorkOrderController.ts, ScheduleController.ts
‚îÇ   ‚îú‚îÄ‚îÄ use-cases/         ‚Üí CreateWorkOrderUseCase.ts, ScheduleMaintenanceUseCase.ts
‚îÇ   ‚îú‚îÄ‚îÄ dto/              ‚Üí CreateAssetDTO.ts, ScheduleWorkOrderDTO.ts
‚îÇ   ‚îî‚îÄ‚îÄ services/         ‚Üí MaintenanceApplicationService.ts
‚îú‚îÄ‚îÄ infrastructure/
‚îÇ   ‚îú‚îÄ‚îÄ repositories/      ‚Üí DrizzleAssetRepository.ts, DrizzleWorkOrderRepository.ts
‚îÇ   ‚îú‚îÄ‚îÄ clients/          ‚Üí IoTSensorClient.ts, MobileAppClient.ts
‚îÇ   ‚îî‚îÄ‚îÄ config/           ‚Üí SchedulingConfig.ts
‚îî‚îÄ‚îÄ routes.ts             ‚Üí Defini√ß√£o de endpoints
```

### Integra√ß√£o Obrigat√≥ria com M√≥dulos Existentes
- **Tickets**: Usar [`Ticket`](rag://rag_source_0) entity para ordens de servi√ßo derivadas de incidentes
- **Materials-Services**: Integrar [`MaterialService`](rag://rag_source_1) para gest√£o de pe√ßas e estoque
- **Aprova√ß√µes**: Reutilizar motor de aprova√ß√µes existente conforme [`PROMPT_MODULO_APROVACOES_COMPLETO.md`](PROMPT_MODULO_APROVACOES_COMPLETO.md)

---

## üìä Modelo de Dados Principal

### Entidades Core
```typescript
// Assets & Locations Hierarchy
assets(id, location_id, parent_asset_id, tag, model, criticality, meters_json, mtbf, mttr, failure_codes_json)
locations(id, parent_location_id, name, timezone, business_hours_json, holidays_json, hierarchy_level)

// Maintenance Planning
maintenance_plans(id, asset_id, trigger_type: 'time'|'meter'|'condition', frequency_json, tasks_template_json, sla_policy_id)
work_orders(id, asset_id, ticket_id, origin: 'pm'|'incident'|'manual'|'condition', priority, status, sla_target_at, idle_policy_json)
wo_tasks(id, wo_id, sequence, required_skill_json, required_cert_json, checklist_json, status, dependencies_json)

// Scheduling & Resources
schedules(id, wo_id, technician_id, planned_start, planned_end, actual_start, actual_end, route_sequence)
shifts(id, pattern: '3x1'|'5x2'|'12x36', calendar_json, effective_from, effective_to)
technicians(id, user_id, skills_json, certifications_json, shift_id, home_base_location_id, availability_json)

// Execution & Tracking
time_entries(id, wo_id, technician_id, start_time, end_time, type: 'travel'|'work'|'wait', notes)
task_executions(id, task_id, checklist_responses_json, photos_json, measurements_json, signature_json, completed_at)
parts_reservations(id, wo_id, material_service_id, quantity_reserved, quantity_used, status)

// SLA & Quality
sla_policies(id, name, scope_json, start_conditions_json, pause_conditions_json, stop_conditions_json, calendar_id)
risk_permits(id, wo_id, permit_type: 'LOTO'|'NR10'|'NR35'|'altura', status, issued_by, valid_until)
```

### Estados das M√°quinas
```typescript
// Work Order States
type WorkOrderStatus = 'drafted' | 'scheduled' | 'in_progress' | 'waiting_parts' | 'waiting_window' | 'waiting_client' | 'completed' | 'approved' | 'closed' | 'rejected' | 'canceled';

// Task States  
type TaskStatus = 'pending' | 'doing' | 'blocked' | 'done' | 'verified';
```

---

## üîÅ Fluxos Principais Obrigat√≥rios

### 1. Cat√°logo de Ativos & Locais
- **Hierarquia**: site ‚Üí pr√©dio ‚Üí √°rea ‚Üí linha ‚Üí m√°quina ‚Üí componente
- **Atributos**: medidores/hor√≠metros, criticidade, MTBF/MTTR, c√≥digos de falha
- **Integra√ß√£o**: Locais vindos do m√≥dulo [`locations`](rag://rag_source_10) existente

### 2. Planos de Manuten√ß√£o (PM)
```typescript
interface MaintenancePlan {
  triggerType: 'time' | 'meter' | 'condition';
  frequency: {
    type: 'daily' | 'weekly' | 'monthly' | 'usage_based' | 'condition_based';
    interval: number;
    unit?: 'hours' | 'km' | 'cycles';
  };
  tasks: MaintenanceTask[];
  slaPolicy: SLAPolicy;
}
```

### 3. Gera√ß√£o de Ordens de Servi√ßo
- **Origens**: PM autom√°tica, chamado/ticket, condi√ß√£o IoT, manual
- **SLA**: Integra√ß√£o com sistema de SLA existente
- **Idle Time SLA**: Monitoramento de tempo ocioso por etapa

### 4. Motor de Scheduling (CORE)
```typescript
interface SchedulingEngine {
  inputs: {
    workOrders: WorkOrder[];
    technicians: Technician[];
    constraints: SchedulingConstraints;
  };
  
  rules: {
    hard: CertificationRule | WindowRule | SafetyRule;
    soft: ProximityRule | LoadBalanceRule | PreferenceRule;
  };
  
  algorithm: 'multi_criteria_score' | 'greedy_improvement' | 'genetic_algorithm';
  
  outputs: {
    schedule: Schedule[];
    routes: RouteOptimization[];
    conflicts: SchedulingConflict[];
  };
}
```

### 5. Execu√ß√£o (Campo & Oficina)
- **App M√≥vel**: Offline-first com sincroniza√ß√£o
- **Valida√ß√µes**: Depend√™ncias, intertravamentos, seguran√ßa
- **Evid√™ncias**: Fotos, medi√ß√µes, assinatura do cliente

### 6. Fechamento & Custos
- **Integra√ß√£o Materials-Services**: Consumo de pe√ßas do [`MaterialService`](rag://rag_source_1)
- **Aprova√ß√µes**: Motor existente para custos e qualidade
- **Auditoria**: Logs completos via [`audit_logs`](rag://rag_source_2)

---

## üîå APIs Obrigat√≥rias

### Assets & Planning
```
POST /api/activity-planner/assets                    # Criar ativo
GET  /api/activity-planner/assets                    # Listar ativos com hierarquia
POST /api/activity-planner/maintenance-plans         # Criar plano PM
GET  /api/activity-planner/maintenance-plans         # Listar planos
```

### Work Orders & Scheduling
```
POST /api/activity-planner/work-orders               # Criar OS
GET  /api/activity-planner/work-orders               # Listar OS com filtros
POST /api/activity-planner/work-orders/{id}/schedule # Atribuir/agendar
PUT  /api/activity-planner/work-orders/{id}/start    # Iniciar execu√ß√£o
PUT  /api/activity-planner/work-orders/{id}/pause    # Pausar OS
PUT  /api/activity-planner/work-orders/{id}/complete # Finalizar OS
```

### Tasks & Execution
```
GET  /api/activity-planner/work-orders/{id}/tasks    # Listar tarefas da OS
POST /api/activity-planner/tasks/{id}/checklist      # Executar checklist
POST /api/activity-planner/tasks/{id}/evidence       # Anexar evid√™ncias
PUT  /api/activity-planner/tasks/{id}/status         # Atualizar status
```

### Scheduling & Resources
```
GET  /api/activity-planner/schedule                  # Agenda consolidada
POST /api/activity-planner/schedule/optimize         # Otimizar programa√ß√£o
GET  /api/activity-planner/technicians               # Listar t√©cnicos
POST /api/activity-planner/shifts                    # Configurar turnos
```

### Parts & Inventory Integration
```
POST /api/activity-planner/parts/reserve             # Reservar pe√ßas (integra materials-services)
POST /api/activity-planner/parts/consume             # Consumir pe√ßas
GET  /api/activity-planner/parts/availability        # Verificar disponibilidade
```

### Analytics & KPIs
```
GET  /api/activity-planner/kpis/maintenance          # M√©tricas consolidadas
GET  /api/activity-planner/reports/sla               # Relat√≥rio SLA
GET  /api/activity-planner/reports/mttr-mtbf         # Indicadores t√©cnicos
GET  /api/activity-planner/reports/pareto            # An√°lise de falhas
```

---

## üñ•Ô∏è Interface Obrigat√≥ria

### 1. Planejamento Visual
- **Calend√°rio**: Vis√£o dia/semana/m√™s com drag & drop
- **Gantt**: Timeline de projetos e depend√™ncias
- **Mapa**: Clusters geogr√°ficos de atividades
- **Conflitos**: Detec√ß√£o autom√°tica de sobreposi√ß√µes

### 2. Backlog Inteligente
- **Kanban**: Por status/criticidade/t√©cnico
- **Sugest√µes**: Motor de IA para otimiza√ß√£o
- **Filtros**: Query builder integrado

### 3. Execu√ß√£o M√≥vel
```typescript
interface MobileExecution {
  offlineSupport: boolean;
  stepByStep: boolean;
  checklistValidation: boolean;
  photoCapture: boolean;
  measurementInput: boolean;
  clientSignature: boolean;
  autoSync: boolean;
}
```

### 4. Gest√£o de Pe√ßas
- **Reserva**: Autom√°tica por BOM do plano
- **Substitutos**: Equival√™ncias configur√°veis
- **Baixa**: Integra√ß√£o com inventory

### 5. Relat√≥rios & Analytics
- **SLA Dashboard**: Cumprimento em tempo real
- **Idle Time**: Monitoramento de ociosidade
- **MTTR/MTBF**: Indicadores por ativo
- **Pareto**: An√°lise de causas de falhas
- **Efic√°cia PM**: Taxa de sucesso preventiva

---

## ‚öôÔ∏è Regras & Automa√ß√µes

### Query Builder Integration
```typescript
interface MaintenanceRule {
  trigger: QueryCondition[];
  actions: AutomationAction[];
  scope: 'pm_generation' | 'wo_approval' | 'sla_escalation';
}
```

### SLA Policies
- **Pausas**: Aguardando cliente/pe√ßa/janela
- **Idle Time**: Por etapa/tarefa (ex: 4h ‚Üí lembrete, 8h ‚Üí reatribuir)
- **Escalonamento**: Hier√°rquico autom√°tico

### Safety & Compliance
- **Permits**: LOTO, NR10/NR35, trabalho em altura
- **EPIs**: Listas obrigat√≥rias por tarefa
- **Bloqueios**: Por risco, custo, parada de linha

---

## üîí Qualidade & Compliance

### Testes Obrigat√≥rios (‚â• 80% cobertura)
```typescript
// Domain Tests
AssetEntity.test.ts
MaintenancePlan.test.ts
SchedulingEngine.test.ts

// Application Tests  
CreateWorkOrderUseCase.test.ts
ScheduleOptimizationUseCase.test.ts

// Infrastructure Tests
DrizzleAssetRepository.test.ts
SchedulingAlgorithm.test.ts

// Integration Tests
WorkOrderFlow.integration.test.ts
MaterialsServiceIntegration.test.ts
```

### Observabilidade
```typescript
interface Metrics {
  scheduling_performance: 'optimization_time_ms';
  sla_compliance: 'percentage_met';
  idle_time: 'average_minutes_per_task';
  pm_effectiveness: 'preventive_success_rate';
}
```

### Auditoria Completa
```sql
-- Todas as transi√ß√µes devem ser auditadas
INSERT INTO audit_logs (tenant_id, user_id, action_type, entity_type, entity_id, old_values, new_values, snapshots, created_at)
VALUES (?, ?, 'work_order_status_changed', 'work_order', ?, ?, ?, ?, NOW());
```

### Acessibilidade WCAG 2.1 AA
- **Contraste**: M√≠nimo 4.5:1
- **Navega√ß√£o**: Teclado completa
- **Screen Reader**: Labels sem√¢nticos
- **Focus Management**: Indicadores visuais

---

## üß≠ Integra√ß√£o com Ecosystem

### Depend√™ncias de M√≥dulos
```typescript
// Tickets Integration
import { TicketEntity } from '../tickets/domain/entities/Ticket';

// Materials-Services Integration  
import { MaterialServiceEntity } from '../materials-services/domain/entities/MaterialService';

// Approvals Integration
import { ApprovalWorkflow } from '../approvals/domain/entities/ApprovalWorkflow';
```

### Database Multi-tenant
```sql
-- Seguir padr√£o tenant schema
CREATE SCHEMA IF NOT EXISTS tenant_{tenant_id};

-- Todas as tabelas com tenant_id obrigat√≥rio
CREATE TABLE tenant_{tenant_id}.assets (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL REFERENCES public.tenants(id),
  -- demais campos
);
```

---

## ‚úÖ Crit√©rios de Aceite

### Funcional
- [ ] Cria√ß√£o de ativos com hierarquia completa
- [ ] Planos PM por tempo/uso/condi√ß√£o
- [ ] Gera√ß√£o autom√°tica de OS
- [ ] Motor de scheduling otimizado
- [ ] Execu√ß√£o m√≥vel offline
- [ ] Integra√ß√£o completa materials-services
- [ ] SLA e Idle Time funcionando
- [ ] Aprova√ß√µes integradas
- [ ] Relat√≥rios e KPIs

### T√©cnico
- [ ] Clean Architecture 100%
- [ ] Cobertura testes ‚â• 80%
- [ ] Performance: scheduling < 5s para 1000 OS
- [ ] Mobile: sincroniza√ß√£o < 30s
- [ ] Auditoria: 100% das transi√ß√µes
- [ ] Acessibilidade WCAG 2.1 AA

### Integra√ß√£o
- [ ] Tickets: OS derivadas de incidentes
- [ ] Materials: Consumo autom√°tico
- [ ] Aprova√ß√µes: Fluxos customiz√°veis
- [ ] Locais: Hierarquia sincronizada
- [ ] SLA: Pol√≠ticas globais

---

**RESULTADO ESPERADO**: Um m√≥dulo completo de Planejador de Atividades que seja o n√∫cleo da gest√£o de manuten√ß√£o, totalmente integrado ao ecossistema Conductor, seguindo rigorosamente os padr√µes Clean Architecture e proporcionando uma experi√™ncia de usu√°rio excepcional tanto web quanto m√≥vel.

// TESTES AUTOMATIZADOS - ETAPA 2: MOVIMENTA√á√ïES DE ESTOQUE
const { Pool } = require('pg');

const TENANT_ID_TEST = '3f99462f-3621-4b1b-bea8-782acc50d62e';
const BASE_URL = 'http://localhost:5000';

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false
});

class PartsServicesEtapa2Tester {
  constructor() {
    this.authToken = null;
    this.testResults = [];
    this.createdMovements = [];
    this.testPartId = null;
    this.testLocationId = null;
    this.testSecondLocationId = null;
  }

  async runAllTests() {
    console.log('üß™ INICIANDO TESTES - ETAPA 2: MOVIMENTA√á√ïES DE ESTOQUE');
    console.log('=' .repeat(60));

    try {
      await this.setupTests();
      await this.testDatabaseSchemaEtapa2();
      await this.testStockEntryAPI();
      await this.testStockExitAPI();
      await this.testStockTransferAPI();
      await this.testMovementsAPI();
      await this.testLotsAPI();
      await this.testReportsAPI();
      await this.cleanupTests();
      this.generateTestReport();
      
    } catch (error) {
      console.error('‚ùå ERRO CR√çTICO NOS TESTES:', error);
      process.exit(1);
    }
  }

  async setupTests() {
    console.log('\nüìã ETAPA: Setup e Prepara√ß√£o');
    
    try {
      // Fazer login
      const loginResponse = await fetch(`${BASE_URL}/api/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: 'alex@conductor.com',
          password: 'senha123'
        })
      });

      const loginData = await loginResponse.json();
      this.authToken = loginData.token;
      
      // Buscar pe√ßa e localiza√ß√µes de teste
      const partsResponse = await fetch(`${BASE_URL}/api/parts-services/parts`, {
        headers: { 'Authorization': `Bearer ${this.authToken}` }
      });
      const parts = await partsResponse.json();
      this.testPartId = parts[0]?.id;

      const locationsResponse = await fetch(`${BASE_URL}/api/parts-services/etapa1/stock-locations`, {
        headers: { 'Authorization': `Bearer ${this.authToken}` }
      });
      const locations = await locationsResponse.json();
      this.testLocationId = locations[0]?.id;
      this.testSecondLocationId = locations[1]?.id;
      
      this.addTestResult('setup', 'Prepara√ß√£o de dados', 
        !!(this.authToken && this.testPartId && this.testLocationId), 
        'Dados de teste preparados'
      );
      
    } catch (error) {
      this.addTestResult('setup', 'Prepara√ß√£o de dados', false, error.message);
      throw error;
    }
  }

  async testDatabaseSchemaEtapa2() {
    console.log('\nüìä ETAPA: Valida√ß√£o do Schema Etapa 2');
    
    try {
      const tablesQuery = `
        SELECT table_name 
        FROM information_schema.tables 
        WHERE table_schema = 'tenant_${TENANT_ID_TEST.replace(/-/g, '_')}'
        AND table_name IN ('stock_movements', 'stock_lots', 'movement_approval_rules');
      `;
      
      const tablesResult = await pool.query(tablesQuery);
      const tableNames = tablesResult.rows.map(row => row.table_name);
      
      this.addTestResult('database', 'Tabela stock_movements', 
        tableNames.includes('stock_movements'), 
        'Tabela de movimenta√ß√µes criada'
      );
      
      this.addTestResult('database', 'Tabela stock_lots', 
        tableNames.includes('stock_lots'), 
        'Tabela de lotes criada'
      );

      this.addTestResult('database', 'Tabela movement_approval_rules', 
        tableNames.includes('movement_approval_rules'), 
        'Tabela de regras de aprova√ß√£o criada'
      );

      // Verificar triggers
      const triggerQuery = `
        SELECT trigger_name 
        FROM information_schema.triggers 
        WHERE event_object_schema = 'tenant_${TENANT_ID_TEST.replace(/-/g, '_')}'
        AND trigger_name = 'trigger_update_inventory_after_movement';
      `;
      
      const triggerResult = await pool.query(triggerQuery);
      
      this.addTestResult('database', 'Trigger de atualiza√ß√£o autom√°tica', 
        triggerResult.rows.length > 0, 
        'Trigger de invent√°rio configurado'
      );

      console.log('‚úÖ Schema Etapa 2 validado');
      
    } catch (error) {
      this.addTestResult('database', 'Valida√ß√£o Schema Etapa 2', false, error.message);
      throw error;
    }
  }

  async testStockEntryAPI() {
    console.log('\nüì¶ ETAPA: Testes de Entrada de Estoque');
    
    try {
      const entryData = {
        part_id: this.testPartId,
        location_id: this.testLocationId,
        quantity: 50,
        unit_cost: 25.50,
        lot_number: 'TEST-LOT-001',
        expiration_date: '2025-12-31',
        notes: 'Entrada de teste - Etapa 2',
        original_quantity: 50
      };

      const response = await fetch(`${BASE_URL}/api/parts-services/etapa2/stock/entry`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this.authToken}`
        },
        body: JSON.stringify(entryData)
      });

      const result = await response.json();
      
      this.addTestResult('movements', 'Entrada de Estoque', 
        response.ok && result.success, 
        response.ok ? 'Entrada registrada com sucesso' : result.message
      );

      if (result.success) {
        this.createdMovements.push(result.data.id);
      }

      console.log('‚úÖ Teste de entrada conclu√≠do');
      
    } catch (error) {
      this.addTestResult('movements', 'Entrada de Estoque', false, error.message);
    }
  }

  async testStockExitAPI() {
    console.log('\nüì§ ETAPA: Testes de Sa√≠da de Estoque');
    
    try {
      const exitData = {
        part_id: this.testPartId,
        location_id: this.testLocationId,
        quantity: 10,
        notes: 'Sa√≠da de teste - Etapa 2'
      };

      const response = await fetch(`${BASE_URL}/api/parts-services/etapa2/stock/exit`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this.authToken}`
        },
        body: JSON.stringify(exitData)
      });

      const result = await response.json();
      
      this.addTestResult('movements', 'Sa√≠da de Estoque', 
        response.ok && result.success, 
        response.ok ? 'Sa√≠da registrada com sucesso' : result.message
      );

      if (result.success) {
        this.createdMovements.push(result.data.id);
      }

      console.log('‚úÖ Teste de sa√≠da conclu√≠do');
      
    } catch (error) {
      this.addTestResult('movements', 'Sa√≠da de Estoque', false, error.message);
    }
  }

  async testStockTransferAPI() {
    console.log('\nüîÑ ETAPA: Testes de Transfer√™ncia');
    
    try {
      if (!this.testSecondLocationId) {
        this.addTestResult('movements', 'Transfer√™ncia de Estoque', false, 'Segunda localiza√ß√£o n√£o dispon√≠vel');
        return;
      }

      const transferData = {
        part_id: this.testPartId,
        source_location_id: this.testLocationId,
        destination_location_id: this.testSecondLocationId,
        quantity: 5,
        notes: 'Transfer√™ncia de teste - Etapa 2'
      };

      const response = await fetch(`${BASE_URL}/api/parts-services/etapa2/stock/transfer`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this.authToken}`
        },
        body: JSON.stringify(transferData)
      });

      const result = await response.json();
      
      this.addTestResult('movements', 'Transfer√™ncia de Estoque', 
        response.ok && result.success, 
        response.ok ? 'Transfer√™ncia registrada com sucesso' : result.message
      );

      if (result.success) {
        this.createdMovements.push(result.data.id);
      }

      console.log('‚úÖ Teste de transfer√™ncia conclu√≠do');
      
    } catch (error) {
      this.addTestResult('movements', 'Transfer√™ncia de Estoque', false, error.message);
    }
  }

  async testMovementsAPI() {
    console.log('\nüìã ETAPA: Testes de API de Movimenta√ß√µes');
    
    try {
      // Listar todas as movimenta√ß√µes
      const response = await fetch(`${BASE_URL}/api/parts-services/etapa2/movements`, {
        headers: { 'Authorization': `Bearer ${this.authToken}` }
      });

      const movements = await response.json();
      
      this.addTestResult('api', 'Listar Movimenta√ß√µes', 
        response.ok && Array.isArray(movements), 
        `${movements.length || 0} movimenta√ß√µes encontradas`
      );

      // Testar filtros
      const filteredResponse = await fetch(`${BASE_URL}/api/parts-services/etapa2/movements?movementType=IN`, {
        headers: { 'Authorization': `Bearer ${this.authToken}` }
      });

      const filteredMovements = await filteredResponse.json();
      
      this.addTestResult('api', 'Filtrar Movimenta√ß√µes', 
        filteredResponse.ok && Array.isArray(filteredMovements), 
        `Filtro por tipo funcionando`
      );

      console.log('‚úÖ Testes de API conclu√≠dos');
      
    } catch (error) {
      this.addTestResult('api', 'API de Movimenta√ß√µes', false, error.message);
    }
  }

  async testLotsAPI() {
    console.log('\nüè∑Ô∏è ETAPA: Testes de Lotes e Rastreabilidade');
    
    try {
      const response = await fetch(`${BASE_URL}/api/parts-services/etapa2/lots`, {
        headers: { 'Authorization': `Bearer ${this.authToken}` }
      });

      const lots = await response.json();
      
      this.addTestResult('lots', 'Listar Lotes', 
        response.ok && Array.isArray(lots), 
        `${lots.length || 0} lotes encontrados`
      );

      // Teste de lotes vencendo
      const expiringResponse = await fetch(`${BASE_URL}/api/parts-services/etapa2/lots/expiring?daysAhead=365`, {
        headers: { 'Authorization': `Bearer ${this.authToken}` }
      });

      const expiringLots = await expiringResponse.json();
      
      this.addTestResult('lots', 'Lotes Vencendo', 
        expiringResponse.ok && Array.isArray(expiringLots), 
        `${expiringLots.length || 0} lotes vencendo`
      );

      console.log('‚úÖ Testes de lotes conclu√≠dos');
      
    } catch (error) {
      this.addTestResult('lots', 'Testes de Lotes', false, error.message);
    }
  }

  async testReportsAPI() {
    console.log('\nüìä ETAPA: Testes de Relat√≥rios');
    
    try {
      // Relat√≥rio de giro de estoque
      const turnoverResponse = await fetch(`${BASE_URL}/api/parts-services/etapa2/reports/turnover`, {
        headers: { 'Authorization': `Bearer ${this.authToken}` }
      });

      const turnoverReport = await turnoverResponse.json();
      
      this.addTestResult('reports', 'Relat√≥rio de Giro', 
        turnoverResponse.ok && Array.isArray(turnoverReport), 
        `Relat√≥rio de giro gerado`
      );

      // Relat√≥rio de avalia√ß√£o de invent√°rio
      const valuationResponse = await fetch(`${BASE_URL}/api/parts-services/etapa2/reports/valuation`, {
        headers: { 'Authorization': `Bearer ${this.authToken}` }
      });

      const valuationReport = await valuationResponse.json();
      
      this.addTestResult('reports', 'Avalia√ß√£o de Invent√°rio', 
        valuationResponse.ok && Array.isArray(valuationReport), 
        `Relat√≥rio de avalia√ß√£o gerado`
      );

      console.log('‚úÖ Testes de relat√≥rios conclu√≠dos');
      
    } catch (error) {
      this.addTestResult('reports', 'Testes de Relat√≥rios', false, error.message);
    }
  }

  async cleanupTests() {
    console.log('\nüßπ ETAPA: Limpeza dos Dados de Teste');
    
    try {
      // Nota: As movimenta√ß√µes geralmente n√£o s√£o removidas para manter auditoria
      // Mas podemos marcar como teste ou cancelar se necess√°rio
      
      this.addTestResult('cleanup', 'Limpeza dos Dados', true, 'Dados de teste mantidos para auditoria');
      console.log('‚úÖ Limpeza conclu√≠da (dados mantidos para auditoria)');
      
    } catch (error) {
      this.addTestResult('cleanup', 'Limpeza dos Dados', false, error.message);
    }
  }

  addTestResult(category, testName, passed, message) {
    this.testResults.push({
      category,
      testName,
      passed,
      message,
      timestamp: new Date().toISOString()
    });
  }

  generateTestReport() {
    console.log('\nüìã RELAT√ìRIO FINAL DOS TESTES - ETAPA 2');
    console.log('=' .repeat(60));
    
    const categories = ['setup', 'database', 'movements', 'api', 'lots', 'reports', 'cleanup'];
    let totalTests = 0;
    let passedTests = 0;

    categories.forEach(category => {
      const categoryTests = this.testResults.filter(test => test.category === category);
      const categoryPassed = categoryTests.filter(test => test.passed).length;
      
      console.log(`\nüî∑ ${category.toUpperCase()}:`);
      categoryTests.forEach(test => {
        const status = test.passed ? '‚úÖ' : '‚ùå';
        console.log(`  ${status} ${test.testName}: ${test.message}`);
      });
      
      console.log(`  ‚îî‚îÄ ${categoryPassed}/${categoryTests.length} testes passaram`);
      
      totalTests += categoryTests.length;
      passedTests += categoryPassed;
    });

    console.log('\n' + '=' .repeat(60));
    console.log(`üéØ RESULTADO FINAL: ${passedTests}/${totalTests} testes passaram`);
    console.log(`üìä Taxa de Sucesso: ${((passedTests/totalTests) * 100).toFixed(1)}%`);
    
    if (passedTests === totalTests) {
      console.log('üéâ TODOS OS TESTES PASSARAM! Etapa 2 est√° pronta para produ√ß√£o.');
      console.log('üì¶ Funcionalidades implementadas:');
      console.log('   ‚úÖ Movimenta√ß√µes reais de estoque (IN/OUT/TRANSFER)');
      console.log('   ‚úÖ Rastreabilidade por lotes e serial numbers');
      console.log('   ‚úÖ Sistema de aprova√ß√£o de movimenta√ß√µes');
      console.log('   ‚úÖ Relat√≥rios de giro e avalia√ß√£o de invent√°rio');
      console.log('   ‚úÖ Triggers autom√°ticos de atualiza√ß√£o de invent√°rio');
    } else {
      console.log('‚ö†Ô∏è  Alguns testes falharam. Revisar antes de prosseguir para Etapa 3.');
    }
    
    console.log('=' .repeat(60));
  }
}

// Executar testes se chamado diretamente
if (require.main === module) {
  const tester = new PartsServicesEtapa2Tester();
  tester.runAllTests();
}

module.exports = PartsServicesEtapa2Tester;


const API_BASE = 'http://localhost:5000/api';

class PartsServicesEtapa7Tester {
  constructor() {
    this.accessToken = process.env.ACCESS_TOKEN || '';
    this.tenantId = '3f99462f-3621-4b1b-bea8-782acc50d62e';
  }

  async makeRequest(endpoint, method = 'GET', data = null) {
    const url = `${API_BASE}${endpoint}`;
    const options = {
      method,
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${this.accessToken}`
      }
    };

    if (data && (method === 'POST' || method === 'PUT')) {
      options.body = JSON.stringify(data);
    }

    try {
      const response = await fetch(url, options);
      const responseData = await response.json();
      
      return {
        success: response.ok,
        status: response.status,
        data: responseData
      };
    } catch (error) {
      return {
        success: false,
        error: error.message
      };
    }
  }

  async testStockMovementsReal() {
    console.log('\nüì¶ TESTANDO MOVIMENTA√á√ïES REAIS DE ESTOQUE...');
    
    // Teste 1: Listar movimenta√ß√µes
    console.log('üìã Teste 1: Listar movimenta√ß√µes reais');
    const listResult = await this.makeRequest('/parts-services/etapa7/stock-movements-real');
    console.log(`   Status: ${listResult.status}`);
    console.log(`   Sucesso: ${listResult.success}`);
    console.log(`   Movimenta√ß√µes encontradas: ${listResult.data?.data?.length || 0}`);

    // Teste 2: Criar nova movimenta√ß√£o
    console.log('‚ûï Teste 2: Criar nova movimenta√ß√£o');
    const newMovement = {
      movementType: 'OUT',
      referenceType: 'work_order',
      partId: '1114c317-7a61-41e1-98c2-9e4d8f7a6b5c',
      fromLocationId: '9b8c7d6e-5f4e-3d2c-1b0a-9e8d7c6b5a4f',
      quantity: 10,
      unitCost: 25.50,
      totalCost: 255.00,
      batchNumber: 'BATCH-2024-001',
      notes: 'Movimenta√ß√£o de teste para work order'
    };

    const createResult = await this.makeRequest('/parts-services/etapa7/stock-movements-real', 'POST', newMovement);
    console.log(`   Status: ${createResult.status}`);
    console.log(`   Sucesso: ${createResult.success}`);
    if (createResult.success) {
      console.log(`   Movimenta√ß√£o criada com ID: ${createResult.data?.data?.id}`);
      console.log(`   N√∫mero da movimenta√ß√£o: ${createResult.data?.data?.movementNumber}`);
      this.testMovementId = createResult.data?.data?.id;
    }

    // Teste 3: Aprovar movimenta√ß√£o
    if (this.testMovementId) {
      console.log('‚úÖ Teste 3: Aprovar movimenta√ß√£o');
      const approveResult = await this.makeRequest(`/parts-services/etapa7/stock-movements-real/${this.testMovementId}/approve`, 'PUT');
      console.log(`   Status: ${approveResult.status}`);
      console.log(`   Sucesso: ${approveResult.success}`);
    }

    // Teste 4: Executar movimenta√ß√£o
    if (this.testMovementId) {
      console.log('üöÄ Teste 4: Executar movimenta√ß√£o');
      const executeResult = await this.makeRequest(`/parts-services/etapa7/stock-movements-real/${this.testMovementId}/execute`, 'PUT');
      console.log(`   Status: ${executeResult.status}`);
      console.log(`   Sucesso: ${executeResult.success}`);
    }

    return { listResult, createResult };
  }

  async testABCAnalysis() {
    console.log('\nüìä TESTANDO AN√ÅLISE ABC...');
    
    // Teste 1: Executar an√°lise ABC
    console.log('üî¨ Teste 1: Executar an√°lise ABC');
    const periodStart = new Date();
    periodStart.setMonth(periodStart.getMonth() - 6);
    const periodEnd = new Date();
    
    const runAnalysisResult = await this.makeRequest('/parts-services/etapa7/abc-analysis/run', 'POST', {
      periodStart: periodStart.toISOString(),
      periodEnd: periodEnd.toISOString()
    });
    console.log(`   Status: ${runAnalysisResult.status}`);
    console.log(`   Sucesso: ${runAnalysisResult.success}`);
    console.log(`   Itens analisados: ${runAnalysisResult.data?.data?.length || 0}`);

    // Teste 2: Buscar resultados da an√°lise
    console.log('üìã Teste 2: Buscar resultados da an√°lise ABC');
    const getAnalysisResult = await this.makeRequest('/parts-services/etapa7/abc-analysis');
    console.log(`   Status: ${getAnalysisResult.status}`);
    console.log(`   Sucesso: ${getAnalysisResult.success}`);
    console.log(`   An√°lises encontradas: ${getAnalysisResult.data?.data?.length || 0}`);

    return { runAnalysisResult, getAnalysisResult };
  }

  async testDemandForecasting() {
    console.log('\nüîÆ TESTANDO PREVIS√ÉO DE DEMANDA...');
    
    // Teste 1: Gerar previs√£o de demanda
    console.log('üìà Teste 1: Gerar previs√£o de demanda');
    const forecastResult = await this.makeRequest('/parts-services/etapa7/demand-forecast/generate', 'POST', {
      partId: '1114c317-7a61-41e1-98c2-9e4d8f7a6b5c',
      forecastPeriods: 6
    });
    console.log(`   Status: ${forecastResult.status}`);
    console.log(`   Sucesso: ${forecastResult.success}`);
    console.log(`   Previs√µes geradas: ${forecastResult.data?.data?.length || 0}`);

    if (forecastResult.success && forecastResult.data?.data?.length > 0) {
      const firstForecast = forecastResult.data.data[0];
      console.log(`   üìä Primeira previs√£o:`);
      console.log(`      ‚Ä¢ Quantidade prevista: ${firstForecast.forecastedQuantity}`);
      console.log(`      ‚Ä¢ Confian√ßa: ${firstForecast.confidenceLevel * 100}%`);
      console.log(`      ‚Ä¢ M√©todo: ${firstForecast.forecastMethod}`);
    }

    return { forecastResult };
  }

  async testStockAlerts() {
    console.log('\nüö® TESTANDO ALERTAS DE ESTOQUE...');
    
    // Teste 1: Listar alertas
    console.log('üìã Teste 1: Listar alertas de estoque');
    const listResult = await this.makeRequest('/parts-services/etapa7/stock-alerts');
    console.log(`   Status: ${listResult.status}`);
    console.log(`   Sucesso: ${listResult.success}`);
    console.log(`   Alertas encontrados: ${listResult.data?.data?.length || 0}`);

    // Teste 2: Criar novo alerta
    console.log('‚ûï Teste 2: Criar novo alerta');
    const newAlert = {
      partId: '1114c317-7a61-41e1-98c2-9e4d8f7a6b5c',
      alertType: 'low_stock',
      severity: 'high',
      currentQuantity: 5,
      thresholdQuantity: 10,
      recommendedAction: 'reorder_immediately',
      alertTitle: 'Estoque Baixo - Pe√ßa Cr√≠tica',
      alertDescription: 'Pe√ßa atingiu n√≠vel cr√≠tico de estoque. Reposi√ß√£o imediata necess√°ria.',
      expirationDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString()
    };

    const createResult = await this.makeRequest('/parts-services/etapa7/stock-alerts', 'POST', newAlert);
    console.log(`   Status: ${createResult.status}`);
    console.log(`   Sucesso: ${createResult.success}`);
    if (createResult.success) {
      console.log(`   Alerta criado com ID: ${createResult.data?.data?.id}`);
    }

    return { listResult, createResult };
  }

  async testDashboardStats() {
    console.log('\nüìä TESTANDO DASHBOARD STATS ETAPA 7...');
    
    const statsResult = await this.makeRequest('/parts-services/etapa7/dashboard-stats-etapa7');
    console.log(`   Status: ${statsResult.status}`);
    console.log(`   Sucesso: ${statsResult.success}`);
    
    if (statsResult.success && statsResult.data?.data) {
      const stats = statsResult.data.data;
      console.log(`   üìà ESTAT√çSTICAS DE MOVIMENTA√á√ïES E ANALYTICS:`);
      console.log(`      ‚Ä¢ Movimenta√ß√µes Pendentes: ${stats.pending_movements || 0}`);
      console.log(`      ‚Ä¢ Movimenta√ß√µes Hoje: ${stats.today_movements || 0}`);
      console.log(`      ‚Ä¢ Alertas Ativos: ${stats.active_alerts || 0}`);
      console.log(`      ‚Ä¢ Alertas Cr√≠ticos: ${stats.critical_alerts || 0}`);
      console.log(`      ‚Ä¢ Pe√ßas com An√°lise ABC: ${stats.parts_with_abc || 0}`);
      console.log(`      ‚Ä¢ Previs√µes Ativas: ${stats.active_forecasts || 0}`);
      console.log(`      ‚Ä¢ Precis√£o M√©dia das Previs√µes: ${parseFloat(stats.avg_forecast_accuracy || 0).toFixed(1)}%`);
      console.log(`      ‚Ä¢ Consumo Mensal (Valor): R$ ${parseFloat(stats.monthly_consumption_value || 0).toLocaleString()}`);
    }

    return statsResult;
  }

  async runAllTests() {
    console.log('üöÄ INICIANDO TESTES DA ETAPA 7 - MOVIMENTA√á√ïES REAIS E ANALYTICS');
    console.log('=' .repeat(80));

    const results = {};

    try {
      // Executar todos os testes
      results.movements = await this.testStockMovementsReal();
      results.abcAnalysis = await this.testABCAnalysis();
      results.forecasting = await this.testDemandForecasting();
      results.alerts = await this.testStockAlerts();
      results.dashboard = await this.testDashboardStats();

      // Resumo dos resultados
      console.log('\nüìã RESUMO DOS TESTES DA ETAPA 7:');
      console.log('=' .repeat(50));

      const modules = [
        { name: 'Movimenta√ß√µes Reais de Estoque', result: results.movements },
        { name: 'An√°lise ABC Autom√°tica', result: results.abcAnalysis },
        { name: 'Previs√£o de Demanda', result: results.forecasting },
        { name: 'Alertas de Estoque', result: results.alerts },
        { name: 'Dashboard Stats', result: results.dashboard }
      ];

      let successCount = 0;
      modules.forEach(module => {
        const success = Object.values(module.result).some(r => r?.success);
        console.log(`${success ? '‚úÖ' : '‚ùå'} ${module.name}: ${success ? 'PASSOU' : 'FALHOU'}`);
        if (success) successCount++;
      });

      console.log('\nüéØ RESULTADO FINAL DA ETAPA 7:');
      console.log(`   M√≥dulos testados: ${modules.length}`);
      console.log(`   M√≥dulos com sucesso: ${successCount}`);
      console.log(`   Taxa de sucesso: ${((successCount / modules.length) * 100).toFixed(1)}%`);

      if (successCount === modules.length) {
        console.log('\nüèÜ ETAPA 7 CONCLU√çDA COM SUCESSO!');
        console.log('üéâ SISTEMA DE MOVIMENTA√á√ïES REAIS E ANALYTICS FUNCIONANDO!');
        console.log('\nüìã FUNCIONALIDADES IMPLEMENTADAS NA ETAPA 7:');
        console.log('   üì¶ Sistema real de movimenta√ß√µes com persist√™ncia');
        console.log('   üî¨ An√°lise ABC autom√°tica baseada em dados reais');
        console.log('   üîÆ Previs√£o de demanda com algoritmos inteligentes');
        console.log('   üö® Sistema de alertas autom√°ticos de estoque');
        console.log('   üìä Analytics avan√ßados com m√©tricas de performance');
        console.log('   ‚úÖ Workflow de aprova√ß√£o e execu√ß√£o de movimenta√ß√µes');
      } else {
        console.log('‚ö†Ô∏è  Alguns m√≥dulos falharam. Revisar implementa√ß√£o.');
      }

    } catch (error) {
      console.error('‚ùå Erro durante os testes:', error);
    }

    console.log('=' .repeat(80));
  }
}

// Executar testes se chamado diretamente
if (require.main === module) {
  const tester = new PartsServicesEtapa7Tester();
  tester.runAllTests().catch(console.error);
}

module.exports = PartsServicesEtapa7Tester;
